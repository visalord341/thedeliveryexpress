<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Delivery Express - Europe's largest fully integrated logistics services provider</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>

    <header class="navbar">
        <div class="logo">
            <a style="text-decoration: none;" class="logo-text" href="index.html">TDE</a>
        </div>
        <div class="hamburger" onclick="toggleMenu()">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
        <nav class="nav-links mobile-nav">
            <a href="services.html" class="nav-item">Services</a>
            <a href="solutions.html" class="nav-item">Solutions</a>
            <a href="partiner.html" class="nav-item">Partner</a>
            <a href="company.html" class="nav-item">Company</a>
            <a href="track.html" class="nav-item">Track</a>
            <a href="support.html" class="nav-item">Support</a>
            <div class="nav-item dropdown">
                <a href="#" class="dropbtn" onclick="toggleDropdown(event)">Ship Now <i class="fas fa-chevron-down"></i></a>
                <div class="dropdown-content">
                    <a href="domestics.html">Direct Ship</a>
                    <a href="login.html">Busines Shipments</a>
                </div>
            </div>
        </nav>
    </header>

    <div class="notification-bar">
        <div class="ticker-container">
            <div class="ticker-content">
                <span>
                    The Delivery Express does not require OTP or credentials for address confirmation for your delivery.
                </span>
                <span>
                    Our Customer Support team is reachable only from our website or app. Login with your phone number and raise your support request with us.
                </span>
                <span>
                    SERVICE UPDATES: Beware of emails or communications from any other source.
                </span>
            </div>
            <div class="ticker-content" aria-hidden="true">
                <span>
                    Delhivery does not require OTP or credentials for address confirmation for your delivery.
                </span>
                <span>
                    Our Customer Support team is reachable only from our website or app. Login with your phone number and raise your support request with us.
                </span>
                <span>
                    SERVICE UPDATES: Beware of emails or communications from any other source.
                </span>
            </div>
        </div>
    </div>

    <main class="main-content">
        <div class="hero-section">
            <video autoplay loop muted playsinline class="hero-video-background">
                <source src="mixkit-workers-moving-containers-from-a-cargo-ship-4450-hd-ready.mp4" type="video/mp4">
                <source src="videos/your-video.webm" type="video/webm">
                <img src="https://plus.unsplash.com/premium_photo-1661342486992-2a08d4b466ef?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Logistics background image" style="width:100%; height:100%; object-fit:cover;">
                Your browser does not support the video tag.
            </video>

            <div class="hero-overlay">
                <div class="hero-text">
                    <h1>We are Europe's largest fully integrated <span class="highlight">logistics services</span> provider</h1>
                    <div class="service-list">
                        <span class="service-item">Express Parcel</span>
                        <span class="separator">|</span>
                        <span class="service-item">PTL</span>
                        <span class="separator">|</span>
                        <span class="service-item">FTL</span>
                        <span class="separator">|</span>
                        <span class="service-item">Cross Border</span>
                        <span class="separator">|</span>
                        <span class="service-item">Supply Chain</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="track-card-container">
            <div class="track-card">
                <h2>Track your order through</h2>

                <div class="tracking-options">
                    <span class="track-option active" data-type="mobile">Mobile</span>
                    <span class="track-option" data-type="awb">AWB</span>
                    <span class="track-option" data-type="orderId">Order Id</span>
                    <span class="track-option" data-type="lrn">LRN</span>
                </div>

                <div class="tracking-form">
                    <input type="text" id="tracking-input" placeholder="Enter Mobile Number">
                    <button class="otp-button" onclick="searchTracking()">Get Location</button>
                </div>

                <div class="app-downloads">
                    <p>DOWNLOAD OUR APP</p>
                    <div class="app-buttons">
                        <a href="#" class="app-button"><i class="fab fa-google-play"></i> Google Play</a>
                        <a href="#" class="app-button"><i class="fab fa-apple"></i> App Store</a>
                    </div>
                </div>

                <div id="searchResult" style="margin-top: 20px; display: none; padding: 15px; background: #f5f5f5; border-radius: 10px;"></div>
            </div>
        </div>
    </main>

    <div id="popup-container" class="popup-container">
        <div class="popup-content">
            <span class="popup-close">&times;</span>
            <h2 class="popup-title">THE DELIVERY EXPRESS Customer Survey</h2>
            <p class="popup-message">Help us improve your experience and how we serve you by taking our short 3 minutes survey.</p>
            <div class="popup-actions">
                <button class="btn-secondary">No Thanks</button>
                <button class="btn-primary">Give Feedback</button>
            </div>
        </div>
    </div>

    <section class="stats-section">
        <div class="stats-header">
            <h2>Flexibility, Reliability and Scale</h2>
            <h1>The Answer is <span style="color: red; font-weight: bold;"> The Delivery Express</span></h1>
        </div>
        <div class="stats-container">
            <div class="stat-item">
                <div class="stat-icon-container">
                    <i class="fas fa-box-open stat-icon"></i>
                </div>
                <div class="stat-value">3.4 Bn+</div>
                <div class="stat-description">Parcels shipped since inception</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon-container">
                    <i class="fas fa-map-marker-alt stat-icon"></i>
                </div>
                <div class="stat-value">99.5%</div>
                <div class="stat-description">Europe population covered</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon-container">
                    <i class="fas fa-users stat-icon"></i>
                </div>
                <div class="stat-value">33K+</div>
                <div class="stat-description">Businesses served</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon-container">
                    <i class="fas fa-truck-moving stat-icon"></i>
                </div>
                <div class="stat-value">6.1 Mn+</div>
                <div class="stat-description">Tonnes Freight shipped</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon-container">
                    <i class="fas fa-warehouse stat-icon"></i>
                </div>
                <div class="stat-value">20 Mn+</div>
                <div class="stat-description">Square feet logistics infrastructure covered</div>
            </div>
        </div>
    </section>

    <section class="solutions-section">
        <div class="solutions-header-container">
            <h2 class="solutions-title">The Delivery Express's suite of solutions for</h2>
        </div>
        <div class="solutions-container">
            <div class="solution-card">
                <div class="solution-icon-container">
                    <i class="fas fa-store"></i>
                </div>
                <h3 class="solution-card-title">D2C Brands</h3>
                <p>We provide an integrated logistics solution built on Express Parcel, Cross Border, Warehousing, Freight and Software value added services that helps brands deliver faster and provide a superior experience.</p>
            </div>
            <div class="solution-card">
                <div class="solution-icon-container">
                    <i class="fas fa-user"></i>
                </div>
                <h3 class="solution-card-title">Personal Courier</h3>
                <p>UK's only online courier solution for all your personal shipping needs. Send from your location to anywhere in the country and internationally with free doorstep pickup and real time tracking through our app.</p>
            </div>
            <div class="solution-card">
                <div class="solution-icon-container">
                    <i class="fas fa-building"></i>
                </div>
                <h3 class="solution-card-title">B2B Enterprises</h3>
                <p>We provide customised solutions to serve your factory to retailer supply chain end-to-end using our integrated warehousing, technology capabilities and logistics network that improve reliability and reduce cost.</p>
            </div>
        </div>
    </section>

    <section class="services-section">
        <div class="services-content-wrapper">
            <div class="services-header-column">
                <div class="services-header">
                    <h2>Services that power<br>our solutions<br>ecosystem</h2>
                </div>
            </div>
            <div class="services-cards-column">
                <div class="services-card">
                    <div class="card-image-container">
                        <img src="https://images.unsplash.com/photo-1598317940377-d1e5402f1bed?q=80&w=1172&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8fDB8fHx8fA%3D%3D" alt="Express Parcel Service" class="card-image">
                        <div class="card-image-overlay">
                            <span class="card-title">Express Parcel Service</span>
                        </div>
                    </div>
                    <div class="card-description">
                        <p>Send shipments across Europe for parcels across categories including heavy goods. Get value added services like RTO reduction tools, door-step inspection and tracking</p>
                    </div>
                </div>
                <div class="services-card">
                    <div class="card-image-container">
                        <img src="https://images.unsplash.com/photo-1664382953403-fc1ac77073a0?q=80&w=1172&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Warehousing" class="card-image">
                        <div class="card-image-overlay">
                            <span class="card-title">Warehousing</span>
                        </div>
                    </div>
                    <div class="card-description">
                        <p>We store inventory across highly optimised locations across the country to fulfil orders originating across both B2C and B2B channels of sale</p>
                    </div>
                </div>
                <div class="services-card">
                    <div class="card-image-container">
                        <img src="https://images.unsplash.com/photo-1633155565182-16c06ed45ec5?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Part Truckload Freight" class="card-image">
                        <div class="card-image-overlay">
                            <span class="card-title">Part Truckload Freight (PTL)</span>
                        </div>
                    </div>
                    <div class="card-description">
                        <p>Join one of the largest Express PTL networks in Europe. Get door-to-door and hub-to-hub delivery with additions such as multi-modal freight and client dashboard</p>
                    </div>
                </div>
                <div class="services-card">
                    <div class="card-image-container">
                        <img src="https://plus.unsplash.com/premium_photo-1682144324433-ae1ee89a0238?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Full Truckload Freight (FTL)" class="card-image">
                        <div class="card-image-overlay">
                            <span class="card-title">Full Truckload Freight (FTL)</span>
                        </div>
                    </div>
                    <div class="card-description">
                        <p>Move high-volume and high-capacity orders faster with our full Truckload Freight logistics and work with our network of professional Truckload partners as well as our own Fleet</p>
                        <a href="#" class="know-more">Know More <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
                <div class="services-card">
                    <div class="card-image-container">
                        <img src="https://images.unsplash.com/photo-1716388347831-754d18f7bb2d?q=80&w=1073&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Cross Border Service" class="card-image">
                        <div class="card-image-overlay">
                            <span class="card-title">Cross Border Service</span>
                        </div>
                    </div>
                    <div class="card-description">
                        <p>Get door-to-door, port-to-port Express Parcel and Freight services from UK to 220+ countries. Our strategic partners include FedEx and Aramex</p>
                    </div>
                </div>
                <div class="services-card">
                    <div class="card-image-container">
                        <img src="https://images.unsplash.com/photo-1608046304336-241ef14c22fa?q=80&w=1206&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Data Intelligence" class="card-image">
                        <div class="card-image-overlay">
                            <span class="card-title">Data Intelligence</span>
                        </div>
                    </div>
                    <div class="card-description">
                        <p>Power your business with Europe most accurate location intelligence stack. Improve delivery success and gain deep insights about user generated addresses and RTOs</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="cta-section">
        <div class="cta-content">
            <h2>Experience the <strong>operating system</strong> for commerce in Europe</h2>
            <p>Sign up now to start shipping with The Delivery Express</p>
            <div class="cta-buttons">
                <a href="#" class="cta-button">Personal Courier <i class="fas fa-arrow-right"></i></a>
                <a href="#" class="cta-button">Business Shipments <i class="fas fa-arrow-right"></i></a>
            </div>
        </div>
    </section>

    
    <footer class="site-footer">
        <div class="footer-top">
            <div class="footer-logo">
                <span class="logo-text">The Delivery Express</span>
                <div class="footer-meta">
                    <p>ISO 9001: 2015, ISO 27001: 2022 Certified Company</p>
                    <p>CIN: L63090DL2011PLC221234</p>
                </div>
            </div>
        </div>
        <div class="footer-links-container">
            <div class="footer-column">
                <h3>GET IN TOUCH</h3>
                <ul>
                    <p><Strong>Email:</Strong>contact@thedeliveryexpress.org</p>
                    <p><Strong>Phone:</Strong>+447441912610</p>
                    <p><Strong>Address:</Strong>New Oxford St,London WCTV 6PL,United Kingdom</p>
                </ul>
            </div>
            <div class="footer-column">
                <h3>SERVICES</h3>
                <ul>
                    <p>Express </p>
                    <p>Express Parcel</p>
                    <p>Warehousing</p>
                    <p>Part Truckload</p>
                    <p>Full Truckload</p>
                    <p>Cross Border</p>
                    <p>Data Intelligence</p>
                    <p>Software Platform</p>
                </ul>
            </div>
            <div class="footer-column">
                <h3>SOLUTIONS</h3>
                <ul>
                    <li>D2C Brands</li>
                    <li>Personal Courier</li>
                    <li>B2B Enterprises</li>
                </ul>
            </div>
           
            <div class="footer-column">
                <h3>COMPANY</h3>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Governance</a></li>
                    <li><a href="#">Investor Relations</a></li>
                    <li><a href="#">ODR Portal</a></li>
                    <li><a href="#">Press Release</a></li>
                    <li><a href="#">Careers</a></li>
                </ul>
            </div>
        
            <div class="footer-column">
                <h3>POLICIES</h3>
                <ul>
                    <li><a href="#">Terms & Conditions</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Cookie Policy</a></li>
                    <li><a href="#">Fraud Disclaimer</a></li>
                    <li><a href="#">ONDC Disclaimer</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <!-- Floating Chat Button -->
<div id="chat-float-btn" style="position:fixed;bottom:30px;right:30px;z-index:9999;">
    <button id="open-chat-btn" style="border-radius:50%;background:#e53935;color:#fff;padding:18px 20px;border:none;box-shadow:0 2px 6px rgba(0,0,0,0.2);font-size:26px;cursor:pointer;">
        <i class="fas fa-comments"></i>
    </button>
</div>

<!-- Chat Popup -->
<div id="chat-popup" style="display:none;position:fixed;bottom:100px;right:30px;width:350px;max-width:95vw;z-index:10000;background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.2);overflow:hidden;">
    <div style="background:#e53935;padding:12px 16px;color:#fff;font-weight:500;display:flex;align-items:center;justify-content:space-between;">
        <span><i class="fas fa-comments"></i> Chat Support</span>
        <span id="close-chat-btn" style="cursor:pointer;font-size:20px;">&times;</span>
    </div>
    <div style="padding:10px;max-height:340px;overflow-y:auto;" id="chat-admin-list">
        <strong>Select an admin to chat:</strong>
        <ul id="admin-list" style="list-style:none;padding:0;margin:10px 0;">
            <!-- Admins will be rendered here -->
        </ul>
    </div>
    <div id="chat-section" style="display:none;padding:10px;max-height:340px;overflow-y:auto;">
        <div id="chat-messages" style="min-height:120px;max-height:160px;overflow-y:auto;background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:8px;"></div>
        <div>
            <input type="text" id="chat-input" placeholder="Type your message..." style="width:72%;padding:6px 8px;border-radius:6px;border:1px solid #ddd;">
            <button id="send-msg-btn" style="background:#e53935;color:#fff;border:none;padding:7px 14px;border-radius:6px;cursor:pointer;">Send</button>
        </div>
        <button id="back-to-admins" style="background:none;color:#e53935;border:none;margin-top:6px;cursor:pointer;font-size:13px;">&#8592; Back to admin list</button>
    </div>
</div>
    
    <div id="result-popup" class="popup-container" style="display: none;">
        <div class="popup-content" style="max-width:900px;width:90vw;">
            <span class="popup-close" id="result-popup-close">&times;</span>
            <div id="popup-result-body"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        function toggleMenu() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('active');
        }
        function toggleDropdown(event) {
            event.preventDefault();
            const dropdown = event.target.closest('.dropdown');
            dropdown.classList.toggle('active');
        }

        window.onload = function() {
            const popup = document.getElementById('popup-container');
            const closeBtn = document.querySelector('.popup-close');
            popup.style.display = 'flex';
            closeBtn.onclick = function() { popup.style.display = 'none'; }
            window.onclick = function(event) {
                if (event.target === popup) popup.style.display = 'none';
            }
            document.querySelector('.btn-primary').onclick = function() { popup.style.display = 'none'; };
            document.querySelector('.btn-secondary').onclick = function() { popup.style.display = 'none'; };
        };

        document.getElementById('result-popup-close').onclick = function () {
            document.getElementById('result-popup').style.display = 'none';
        }
        window.addEventListener('click', function (e) {
            const popup = document.getElementById('result-popup');
            if (e.target === popup) popup.style.display = 'none';
        });

        // Tracking logic
        const options = document.querySelectorAll('.track-option');
        const inputField = document.getElementById('tracking-input');
        const otpButton = document.querySelector('.otp-button');
        const resultPopup = document.getElementById('result-popup');
        const resultBody = document.getElementById('popup-result-body');
        let selectedTrackingField = 'mobile';
        const placeholders = {
            'mobile': 'Enter Mobile Number',
            'awb': 'Enter AWB Number',
            'orderId': 'Enter Order ID',
            'lrn': 'Enter LRN Number'
        };
        options.forEach(option => {
            option.addEventListener('click', () => {
                options.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                const selectedType = option.dataset.type || 'mobile';
                selectedTrackingField = selectedType;
                inputField.placeholder = placeholders[selectedType] || 'Enter value';
                otpButton.style.display = 'inline-block';
            });
        });
        document.addEventListener('DOMContentLoaded', () => {
            const activeOption = document.querySelector('.track-option.active');
            if (activeOption) activeOption.click();
        });

        // Firebase initialization
        const firebaseConfig = {
            apiKey: "AIzaSyA13edmqgi4_LG-FNW1yN50HTuhtXUes0g",
            authDomain: "travis-d095c.firebaseapp.com",
            projectId: "travis-d095c",
            storageBucket: "travis-d095c.appspot.com",
            messagingSenderId: "169773464605",
            appId: "1:169773464605:web:90584cfa67f8875fc65af4",
            measurementId: "G-Z24WRV168F"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function showTrackingResult(content) {
            resultBody.innerHTML = content;
            resultPopup.style.display = 'flex';
        }
        function formatLogs(logs) {
            if (!Array.isArray(logs) || logs.length === 0) return "<li>No logs available.</li>";
            return logs.map(log =>
                `<li>
                    ${log.status ? `<strong>${log.status}</strong>` : ''}
                    ${log.location ? ` <span>📍 ${log.location}</span>` : ''}
                    ${log.datetime ? ` <span>🕒 ${log.datetime}</span>` : ''}
                </li>`
            ).join("");
        }

        async function searchTracking() {
            const inputValue = inputField.value.trim();
            showTrackingResult("🔍 Searching...");
            if (!inputValue) {
                showTrackingResult("❌ Please enter a valid value.");
                return;
            }
            try {
                const snapshot = await db.collection("orders").where(selectedTrackingField, "==", inputValue).get();
                if (snapshot.empty) {
                    showTrackingResult("❌ No record found.");
                    return;
                }
                const data = snapshot.docs[0].data();
                const createdAt = data.createdAt?.toDate().toLocaleString() || "N/A";
                // Show all fields including admin ones!
                const infoHtml = `
                    <h3>📦 Full Delivery Tracking Information</h3>
                    <table style="width:100%;border-collapse:collapse">
                        <tr><th style="text-align:left;">Tracking Number / AWB / Order ID</th><td>${data.awb || data.orderId || 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">Current Status</th><td>${data.status || 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">Last Known Location</th><td>${data.location || 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">Estimated Delivery Time (ETA)</th><td>${data.eta || 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">Sender Name/Company</th><td>${data.senderName || 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">Recipient Name/Initials</th><td>${data.recipientName || 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">Recipient Signature</th><td>${data.recipientSignature || 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">Weight (kg)</th><td>${data.weight || 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">Dimensions (cm)</th><td>${data.dimensions || 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">Delivery Attempts</th><td>${typeof data.deliveryAttempts === 'number' ? data.deliveryAttempts : 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">Description</th><td>${data.description || 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">Mobile Number</th><td>${data.mobile || 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">LRN Number</th><td>${data.lrn || 'N/A'}</td></tr>
                        <tr><th style="text-align:left;">Order ID</th><td>${data.orderId || 'N/A'}</td></tr>
                    </table>
                    <strong style="display:block;margin:10px 0 5px 0;">Shipment History / Tracking Logs:</strong>
                    <ul style="margin:0 0 10px 15px;">${formatLogs(data.logs)}</ul>
                    <p style="font-size: 12px; color: gray;">Created at: ${createdAt}</p>
                `;
                showTrackingResult(infoHtml);
            } catch (error) {
                console.error("Error fetching tracking info:", error);
                showTrackingResult("❌ Error occurred while searching. Please try again.");
            }
        }
        otpButton.addEventListener('click', searchTracking);
    </script>

    <script>
    // --- USER SIDE CHAT LOGIC: Full and Correct for chatting with admin ---
// Firebase should already be initialized above

// Unique user ID (per browser/session)
let currentUserId = localStorage.getItem("chatUserId");
if (!currentUserId) {
  currentUserId = "guest_" + Math.floor(Math.random()*1000000);
  localStorage.setItem("chatUserId", currentUserId);
}

// Admin list (static demo)
const adminList = [
  { id: 'admin1', name: 'Alice Smith', avatar: 'https://randomuser.me/api/portraits/women/68.jpg' },
  { id: 'admin2', name: 'Bob Johnson', avatar: 'https://randomuser.me/api/portraits/men/44.jpg' }
];

// UI elements
const openChatBtn = document.getElementById('open-chat-btn');
const chatPopup = document.getElementById('chat-popup');
const closeChatBtn = document.getElementById('close-chat-btn');
const adminListUl = document.getElementById('admin-list');
const chatSection = document.getElementById('chat-section');
const chatAdminList = document.getElementById('chat-admin-list');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const sendMsgBtn = document.getElementById('send-msg-btn');
const backToAdminsBtn = document.getElementById('back-to-admins');

let selectedAdmin = null;
let unsubscribeUserChat = null;

// Render admin list
function renderAdmins() {
  adminListUl.innerHTML = '';
  adminList.forEach(admin => {
    const li = document.createElement('li');
    li.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:7px 0;">
        <img src="${admin.avatar}" style="width:32px;height:32px;border-radius:50%;border:1px solid #eee;">
        <span style="font-weight:500;">${admin.name}</span>
      </div>
    `;
    li.onclick = () => openChatWithAdmin(admin);
    adminListUl.appendChild(li);
  });
}

// Show chat popup
openChatBtn.onclick = function() {
  chatPopup.style.display = 'block';
  renderAdmins();
  chatSection.style.display = 'none';
  chatAdminList.style.display = 'block';
};

// Close chat popup
closeChatBtn.onclick = function() {
  chatPopup.style.display = 'none';
};

// Clicking outside chat popup closes it
window.addEventListener('click', function(event) {
  if (event.target === chatPopup) chatPopup.style.display = 'none';
});

// Open chat with selected admin
function openChatWithAdmin(admin) {
  selectedAdmin = admin;
  chatMessages.innerHTML = `<div style="text-align:center;font-size:13px;margin-bottom:5px;color:#e53935;"><strong>Chatting with ${admin.name}</strong></div>`;
  chatSection.style.display = 'block';
  chatAdminList.style.display = 'none';

  // Listen for messages in this user's chat
  if (unsubscribeUserChat) unsubscribeUserChat();
  unsubscribeUserChat = db.collection("chats")
    .doc(currentUserId)
    .collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot => {
      chatMessages.innerHTML = `<div style="text-align:center;font-size:13px;margin-bottom:5px;color:#e53935;"><strong>Chatting with ${admin.name}</strong></div>`;
      snapshot.forEach(doc => {
        const data = doc.data();
        appendMessage(data.sender === "user" ? "You" : admin.name, data.text, data.sender === "user");
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
}

// Back to admin list
backToAdminsBtn.onclick = function() {
  chatSection.style.display = 'none';
  chatAdminList.style.display = 'block';
  selectedAdmin = null;
  if (unsubscribeUserChat) unsubscribeUserChat();
}

// Send message as user
sendMsgBtn.onclick = function() {
  const msg = chatInput.value.trim();
  if (!msg || !selectedAdmin) return;

  db.collection("chats")
    .doc(currentUserId)
    .collection("messages")
    .add({
      sender: "user",
      text: msg,
      adminId: selectedAdmin.id,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

  chatInput.value = "";
};

// Render message bubbles
function appendMessage(sender, text, isUser) {
  const msgDiv = document.createElement('div');
  msgDiv.style = `margin:5px 0;padding:6px 10px;border-radius:7px;max-width:80%;font-size:14px;`;
  msgDiv.style.background = isUser ? '#e53935' : '#eee';
  msgDiv.style.color = isUser ? '#fff' : '#222';
  msgDiv.style.alignSelf = isUser ? 'flex-end' : 'flex-start';
  msgDiv.innerHTML = `<span style="font-weight:500">${sender}:</span> ${text}`;
  chatMessages.appendChild(msgDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Enter to send
chatInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') sendMsgBtn.click();
});
    </script>
</body>
</html>