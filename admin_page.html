<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f0f2fc; display: flex; min-height: 100vh; }
    .sidebar { width: 220px; background: #2f2b65; color: white; padding: 30px 20px; display: flex; flex-direction: column; align-items: center; }
    .profile { text-align: center; margin-bottom: 40px; }
    .profile img { width: 60px; border-radius: 50%; margin-bottom: 10px; }
    .profile h3 { font-size: 18px; }
    .profile p { font-size: 13px; color: #ccc; }
    .main { flex: 1; padding: 30px; }
    .metrics { display: flex; gap: 20px; margin-bottom: 30px; }
    .card { flex: 1; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.05); }
    .card h4 { font-size: 14px; color: #777; margin-bottom: 8px; }
    .card p { font-size: 24px; font-weight: 600; }
    .history { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.05); }
    .history-item { border-bottom: 1px solid #eee; padding: 10px 0; }
    .history-item:last-child { border-bottom: none; }
    .history-item h5 { font-size: 16px; margin-bottom: 4px; }
    .history-item p { font-size: 13px; color: #666; }
    .delivery-info-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .delivery-info-table th, .delivery-info-table td { border: 1px solid #eee; padding: 6px 10px; font-size: 13px; }
    .delivery-info-table th { background: #f9fafc; font-weight: 600; }
    .logs-list { list-style: none; margin: 0; padding-left: 0; }
    .logs-list li { margin-bottom: 10px; font-size: 13px; background: #f6f7ff; border-radius: 8px; padding: 8px 10px; }
    .add-button { position: fixed; bottom: 30px; right: 30px; background: #007bff; color: white; font-size: 24px; padding: 16px; border: none; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh; 
      overflow-y: auto; 
      display: flex;
      flex-direction: column;
    }
    .modal-content h2 { 
      margin-bottom: 20px;
      flex-shrink: 0;
    }
    .modal-body {
      flex-grow: 1;
    }
    .modal-content input, .modal-content textarea { 
      width: 100%; 
      padding: 10px; 
      margin: 8px 0; 
      border-radius: 8px; 
      border: 1px solid #ccc;
      min-height: 40px;
      max-height: 150px;
    }
    .modal-content button { 
      background: #007bff; 
      color: white; 
      padding: 12px; 
      width: 100%; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer;
      margin-top: 10px;
    }
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .edit-btn, .delete-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      background: #007bff;
      color: #fff;
      transition: background 0.2s;
    }
    .delete-btn { background: #dc3545; }
    .edit-btn:hover { background: #0056b3; }
    .delete-btn:hover { background: #bb2d3b; }
    @media (max-width: 768px) {
      .metrics { flex-direction: column; }
      .sidebar { display: none; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="profile">
      <img src="https://i.pravatar.cc/100?img=12" alt="Admin Avatar" />
      <h3>THE DELIVERY EXPRESS</h3>
      <p>Admin</p>
    </div>
  </div>

  <div class="main">
    <h1 style="color: red; margin-bottom: 20px; text-align: center;">ADMIN DASHBOARD</h1>
    <div class="metrics">
      <div class="card"><h4>VISITORS</h4><p>2,150 ▲</p></div>
      <div class="card"><h4>REGISTERED USERS</h4><p>1,430 ▲</p></div>
      <div class="card"><h4>MONTHLY SALES</h4><p>250 ▼</p></div>
    </div>
    <div class="history">
      <h3>🕓 Goods History</h3>
      <div id="historyList">Loading history...</div>
    </div>
  </div>

  <button class="add-button" onclick="openRegisterModal()">+</button>

  <div id="modal" class="modal" onclick="event.target === this && (this.style.display='none')">
    <div class="modal-content">
      <h2 id="modal-title">📦 Register Goods</h2>
      <div class="modal-body">
        <input type="text" id="mobile" placeholder="Customer Mobile Number (+234...)" />
        <input type="text" id="awb" placeholder="AWB Number" />
        <input type="text" id="orderId" placeholder="Order ID" />
        <input type="text" id="lrn" placeholder="LRN Number" />
        <input type="text" id="status" placeholder="Delivery Status (e.g., In Transit)" />
        <input type="date" id="eta" placeholder="Estimated Delivery Date" />
        <input type="text" id="location" placeholder="Current Location" />
        <input type="text" id="senderName" placeholder="Sender Name/Company" />
        <input type="text" id="recipientName" placeholder="Recipient Name/Initials" />
        <input type="text" id="recipientSignature" placeholder="Recipient Signature (for delivered)" />
        <input type="text" id="weight" placeholder="Weight (kg)" />
        <input type="text" id="dimensions" placeholder="Dimensions (cm)" />
        <input type="number" id="deliveryAttempts" placeholder="Delivery Attempts" min="0" />
        <textarea id="description" placeholder="Description of goods"></textarea>
        <textarea id="logs" placeholder="Shipment History / Tracking Logs (one per line: status|location|date/time)"></textarea>
      </div>
      <button id="modal-action-btn" onclick="registerGoods()">Register</button>
      <p id="result"></p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA13edmqgi4_LG-FNW1yN50HTuhtXUes0g",
      authDomain: "travis-d095c.firebaseapp.com",
      projectId: "travis-d095c",
      storageBucket: "travis-d095c.appspot.com",
      messagingSenderId: "169773464605",
      appId: "1:169773464605:web:90584cfa67f8875fc65af4",
      measurementId: "G-Z24WRV168F"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let editingId = null;

    function openRegisterModal(data = null, docId = null) {
      const modal = document.getElementById('modal');
      modal.style.display = 'flex';
      editingId = docId || null;

      [
        "mobile","awb","orderId","lrn","status",
        "eta","location","senderName","recipientName",
        "recipientSignature","weight","dimensions","deliveryAttempts",
        "description","logs"
      ].forEach(id=>document.getElementById(id).value = '');

      if (data) {
        document.getElementById("mobile").value = data.mobile || '';
        document.getElementById("awb").value = data.awb || '';
        document.getElementById("orderId").value = data.orderId || '';
        document.getElementById("lrn").value = data.lrn || '';
        document.getElementById("status").value = data.status || '';
        document.getElementById("eta").value = data.eta || '';
        document.getElementById("location").value = data.location || '';
        document.getElementById("senderName").value = data.senderName || '';
        document.getElementById("recipientName").value = data.recipientName || '';
        document.getElementById("recipientSignature").value = data.recipientSignature || '';
        document.getElementById("weight").value = data.weight || '';
        document.getElementById("dimensions").value = data.dimensions || '';
        document.getElementById("deliveryAttempts").value = typeof data.deliveryAttempts === 'number' ? data.deliveryAttempts : '';
        document.getElementById("description").value = data.description || '';
        document.getElementById("logs").value = Array.isArray(data.logs) ? data.logs.map(l => `${l.status}|${l.location}|${l.datetime}`).join('\n') : '';
      }

      document.getElementById('result').textContent = '';
      document.getElementById('modal-title').textContent = editingId ? "✏️ Edit Goods Information" : "📦 Register Goods";
      document.getElementById('modal-action-btn').textContent = editingId ? "Update" : "Register";
      document.getElementById('modal-action-btn').onclick = editingId ? updateGoods : registerGoods;
    }

    function parseLogs(logsText) {
      return logsText.split('\n').map(line => {
        const [status, location, datetime] = line.split('|').map(x=>x?.trim()||'');
        if (status || location || datetime) {
          return { status, location, datetime }
        }
        return null;
      }).filter(Boolean);
    }

    function registerGoods() {
      const data = {
        mobile: document.getElementById("mobile").value.trim(),
        awb: document.getElementById("awb").value.trim(),
        orderId: document.getElementById("orderId").value.trim(),
        lrn: document.getElementById("lrn").value.trim(),
        status: document.getElementById("status").value.trim(),
        eta: document.getElementById("eta").value.trim(),
        location: document.getElementById("location").value.trim(),
        senderName: document.getElementById("senderName").value.trim(),
        recipientName: document.getElementById("recipientName").value.trim(),
        recipientSignature: document.getElementById("recipientSignature").value.trim(),
        weight: document.getElementById("weight").value.trim(),
        dimensions: document.getElementById("dimensions").value.trim(),
        deliveryAttempts: Number(document.getElementById("deliveryAttempts").value),
        description: document.getElementById("description").value.trim(),
        logs: parseLogs(document.getElementById("logs").value),
        createdAt: new Date()
      };

      db.collection("orders").add(data)
        .then(() => {
          document.getElementById("result").textContent = "✅ Goods Registered Successfully";
          setTimeout(() => {
            document.getElementById('modal').style.display = 'none';
          }, 1500);
          loadHistory();
        })
        .catch(err => {
          alert("❌ Failed to register goods: " + err.message);
          document.getElementById("result").textContent = "❌ Failed to register goods: " + err.message;
          console.error("Register Error: ", err);
        });
    }

    function updateGoods() {
      if (!editingId) return;
      const data = {
  mobile: document.getElementById("mobile").value.trim() || null,
  awb: document.getElementById("awb").value.trim() || null,
  orderId: document.getElementById("orderId").value.trim() || null,
  lrn: document.getElementById("lrn").value.trim() || null,
  status: document.getElementById("status").value.trim() || null,
  eta: document.getElementById("eta").value ? new Date(document.getElementById("eta").value) : null,
  location: document.getElementById("location").value.trim() || null,
  senderName: document.getElementById("senderName").value.trim() || null,
  recipientName: document.getElementById("recipientName").value.trim() || null,
  recipientSignature: document.getElementById("recipientSignature").value.trim() || null,
  weight: document.getElementById("weight").value.trim() || null,
  dimensions: document.getElementById("dimensions").value.trim() || null,
  deliveryAttempts: Number(document.getElementById("deliveryAttempts").value) || 0,
  description: document.getElementById("description").value.trim() || null,
  logs: parseLogs(document.getElementById("logs").value),
  createdAt: new Date()
};


      db.collection("orders").doc(editingId).set(data, {merge:true})
        .then(() => {
          document.getElementById("result").textContent = "✅ Goods Updated Successfully";
          setTimeout(() => {
            document.getElementById('modal').style.display = 'none';
          }, 1500);
          loadHistory();
          editingId = null;
        })
        .catch(err => {
          alert("❌ Failed to update goods: " + err.message);
          document.getElementById("result").textContent = "❌ Failed to update goods: " + err.message;
          console.error("Update Error: ", err);
        });
    }

    function deleteGoods(docId) {
      if (!confirm("Are you sure you want to delete this goods record?")) return;
      db.collection("orders").doc(docId).delete().then(() => {
        loadHistory();
      }).catch(err => {
        alert("❌ Failed to delete goods: " + err.message);
        console.error(err);
      });
    }

    function loadHistory() {
      const historyDiv = document.getElementById("historyList");
      historyDiv.innerHTML = "<p>Loading...</p>";
      db.collection("orders").orderBy("createdAt", "desc").limit(10).get()
        .then(snapshot => {
          historyDiv.innerHTML = "";
          if (snapshot.empty) {
            historyDiv.innerHTML = "<p>No history found.</p>";
            return;
          }
          snapshot.forEach(doc => {
            const data = doc.data();
            const createdAt = data.createdAt?.toDate().toLocaleString() || "N/A";
            const item = document.createElement("div");
            item.className = "history-item";
            // --- THIS IS THE SECTION YOU ASKED FOR! ---
            item.innerHTML = `
              <h5>📦 ${data.orderId || 'N/A'} - ${data.status || 'N/A'}</h5>
              <table class="delivery-info-table">
                <tr><th>Tracking Number / AWB / Order ID</th><td>${data.awb || data.orderId || 'N/A'}</td></tr>
                <tr><th>Current Status</th><td>${data.status || 'N/A'}</td></tr>
                <tr><th>Last Known Location</th><td>${data.location || 'N/A'}</td></tr>
                <tr><th>Estimated Delivery Time (ETA)</th><td>${data.eta || 'N/A'}</td></tr>
                <tr><th>Sender</th><td>${data.senderName || 'N/A'}</td></tr>
                <tr><th>Recipient</th><td>${data.recipientName || 'N/A'}</td></tr>
                <tr><th>Recipient Signature</th><td>${data.recipientSignature || 'N/A'}</td></tr>
                <tr><th>Weight</th><td>${data.weight || 'N/A'}</td></tr>
                <tr><th>Dimensions</th><td>${data.dimensions || 'N/A'}</td></tr>
                <tr><th>Delivery Attempts</th><td>${typeof data.deliveryAttempts === 'number' ? data.deliveryAttempts : 'N/A'}</td></tr>
                <tr><th>Description</th><td>${data.description || 'N/A'}</td></tr>
                <tr><th>Mobile Number</th><td>${data.mobile || 'N/A'}</td></tr>
                <tr><th>LRN Number</th><td>${data.lrn || 'N/A'}</td></tr>
                <tr><th>Order ID</th><td>${data.orderId || 'N/A'}</td></tr>
              </table>
              <strong>Shipment History / Tracking Logs:</strong>
              <ul class="logs-list">
                ${
                  Array.isArray(data.logs) && data.logs.length > 0
                  ? data.logs.map(log => `
                    <li>
                      ${log.status ? `<span>${log.status}</span>` : ''}
                      ${log.location ? ` <span>📍 ${log.location}</span>` : ''}
                      ${log.datetime ? ` <span>🕒 ${log.datetime}</span>` : ''}
                    </li>
                  `).join("")
                  : "<li>No logs available.</li>"
                }
              </ul>
              <p><em>Created: ${createdAt}</em></p>
              <div class="action-buttons">
                <button class="edit-btn" onclick="openRegisterModal(${JSON.stringify(data).replace(/"/g, '&quot;')}, '${doc.id}')">Edit</button>
                <button class="delete-btn" onclick="deleteGoods('${doc.id}')">Delete</button>
              </div>
            `;
            historyDiv.appendChild(item);
          });
        })
        .catch(error => {
          alert("Error loading history: " + error.message);
          historyDiv.innerHTML = "<p>Error loading history.</p>";
          console.error(error);
        });
    }

    window.onload = loadHistory;
  </script>
</body>
</html>