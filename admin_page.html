<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC0EgKGfShZD-TqL7zyVp5S1ErB13tUgMg&libraries=places&callback=initMap" async defer></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f0f2fc; display: flex; min-height: 100vh; }
        .sidebar { width: 220px; background: #2f2b65; color: white; padding: 30px 20px; display: flex; flex-direction: column; align-items: center; }
        .profile { text-align: center; margin-bottom: 40px; }
        .profile img { width: 60px; border-radius: 50%; margin-bottom: 10px; }
        .profile h3 { font-size: 18px; }
        .profile p { font-size: 13px; color: #ccc; }
        .main { flex: 1; padding: 30px; }
        .metrics { display: flex; gap: 20px; margin-bottom: 30px; }
        .card { flex: 1; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.05); }
        .card h4 { font-size: 14px; color: #777; margin-bottom: 8px; }
        .card p { font-size: 24px; font-weight: 600; }
        .history { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.05); }
        .history-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .history-item:last-child { border-bottom: none; }
        .history-item h5 { font-size: 16px; margin-bottom: 4px; }
        .history-item p { font-size: 13px; color: #666; }
        .add-button { position: fixed; bottom: 30px; right: 30px; background: #007bff; color: white; font-size: 24px; padding: 16px; border: none; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
        
        /* Corrected and added styles for the modal to be scrollable */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            /* Allow vertical scrolling */
            max-height: 90vh; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
        }

        .modal-content h2 { 
            margin-bottom: 20px;
            flex-shrink: 0; /* Prevents heading from shrinking when content scrolls */
        }
        
        .modal-body {
            flex-grow: 1;
        }

        .modal-content input, .modal-content textarea { 
            width: 100%; 
            padding: 10px; 
            margin: 8px 0; 
            border-radius: 8px; 
            border: 1px solid #ccc;
            /* Optional: set min and max height for textareas for a better look */
            min-height: 40px;
            max-height: 150px;
        }
        
        .modal-content button { 
            background: #007bff; 
            color: white; 
            padding: 12px; 
            width: 100%; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) { .metrics { flex-direction: column; } .sidebar { display: none; } }
        
        /* ADD THESE STYLES FOR THE MAP */
        #map { height: 300px; width: 100%; margin: 15px 0; border-radius: 8px; }
        #pac-input { background-color: #fff; font-size: 15px; font-weight: 300; margin-left: 12px; padding: 0 11px 0 13px; text-overflow: ellipsis; width: 80%; }
        .pac-container { z-index: 9999; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="profile">
            <img src="https://i.pravatar.cc/100?img=12" alt="Admin Avatar" />
            <h3>THE DELIVERY EXPRESS</h3>
            <p>Admin</p>
        </div>
    </div>

    <div class="main">
        <h1 style="color: red; margin-bottom: 20px; text-align: center;">ADMIN DASHBOARD</h1>
        <div class="metrics">
            <div class="card"><h4>VISITORS</h4><p>2,150 ‚ñ≤</p></div>
            <div class="card"><h4>REGISTERED USERS</h4><p>1,430 ‚ñ≤</p></div>
            <div class="card"><h4>MONTHLY SALES</h4><p>250 ‚ñº</p></div>
        </div>
        <div class="history">
            <h3>üïì Goods History</h3>
            <div id="historyList">Loading history...</div>
        </div>
    </div>

    <button class="add-button" onclick="openRegisterModal()">+</button>

    <div id="modal" class="modal" onclick="event.target === this && (this.style.display='none')">
        <div class="modal-content">
            <h2>üì¶ Register Goods</h2>
            <div class="modal-body">
                <input type="text" id="mobile" placeholder="Customer Mobile Number (+234...)" />
                <input type="text" id="awb" placeholder="AWB Number" />
                <input type="text" id="orderId" placeholder="Order ID" />
                <input type="text" id="lrn" placeholder="LRN Number" />
                <input type="text" id="status" placeholder="Delivery Status (e.g., In Transit)" />
                <input type="text" id="eta" placeholder="Estimated Delivery Date (e.g., 2025-08-10)" />
                
                <input type="text" id="pac-input" placeholder="Search for a location to begin..." />
                <div id="map"></div>
                <input type="text" id="location" placeholder="Current Location (Selected from map)" readonly />
                
                <textarea id="description" placeholder="Description of goods"></textarea>
            </div>
            <button onclick="registerGoods()">Register</button>
            <p id="result"></p>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA13edmqgi4_LG-FNW1yN50HTuhtXUes0g", // This key seems to be public/exposed. Consider securing it.
            authDomain: "travis-d095c.firebaseapp.com",
            projectId: "travis-d095c",
            storageBucket: "travis-d095c.appspot.com",
            messagingSenderId: "169773464605",
            appId: "1:169773464605:web:90584cfa67f8875fc65af4",
            measurementId: "G-Z24WRV168F"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let map;
        let marker;
        let geocoder;

        function openRegisterModal() {
            const modal = document.getElementById('modal');
            modal.style.display = 'flex';
            // Fixes map rendering when its container is initially hidden
            if (map) {
                google.maps.event.trigger(map, 'resize');
            }
            // Clear previous inputs
            document.getElementById('mobile').value = '';
            document.getElementById('awb').value = '';
            document.getElementById('orderId').value = '';
            document.getElementById('lrn').value = '';
            document.getElementById('status').value = '';
            document.getElementById('eta').value = '';
            document.getElementById('pac-input').value = '';
            document.getElementById('description').value = '';
            document.getElementById('result').textContent = '';
        }

        function initMap() {
            // Default location for the map (Port Harcourt, Nigeria)
            const defaultLocation = { lat: 4.8156, lng: 7.0498 };

            map = new google.maps.Map(document.getElementById("map"), {
                center: defaultLocation,
                zoom: 12,
                mapTypeControl: false, 
            });
            
            geocoder = new google.maps.Geocoder();
            
            marker = new google.maps.Marker({
                map: map,
                position: defaultLocation,
                draggable: true,
                title: "Drag to set location"
            });

            google.maps.event.addListener(marker, 'dragend', function(event) {
                updateLocationFromLatLng(event.latLng);
            });

            const input = document.getElementById("pac-input");
            const searchBox = new google.maps.places.SearchBox(input);
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(input);

            map.addListener("bounds_changed", () => {
                searchBox.setBounds(map.getBounds());
            });

            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();
                if (places.length == 0) return;
                
                const place = places[0];
                if (!place.geometry || !place.geometry.location) {
                    console.log("Returned place contains no geometry");
                    return;
                }
                
                map.setCenter(place.geometry.location);
                map.setZoom(15);
                marker.setPosition(place.geometry.location);
                document.getElementById('location').value = place.formatted_address;
            });

            updateLocationFromLatLng(defaultLocation);
        }

        function updateLocationFromLatLng(latLng) {
            geocoder.geocode({ location: latLng }, (results, status) => {
                if (status === "OK") {
                    if (results[0]) {
                        document.getElementById('location').value = results[0].formatted_address;
                    } else {
                        document.getElementById('location').value = "No address found at this location.";
                    }
                } else {
                    document.getElementById('location').value = "Geocoder failed due to: " + status;
                }
            });
        }

        function registerGoods() {
            const locationInput = document.getElementById("location").value.trim();
            if (!locationInput || locationInput.startsWith("Geocoder failed")) {
                document.getElementById("result").textContent = "‚ùå Please select a valid location from the map.";
                return;
            }
            const data = {
                mobile: document.getElementById("mobile").value.trim(),
                awb: document.getElementById("awb").value.trim(),
                orderId: document.getElementById("orderId").value.trim(),
                lrn: document.getElementById("lrn").value.trim(),
                status: document.getElementById("status").value.trim(),
                eta: document.getElementById("eta").value.trim(),
                location: locationInput,
                description: document.getElementById("description").value.trim(),
                createdAt: new Date()
            };
            
            db.collection("orders").add(data).then(() => {
                document.getElementById("result").textContent = "‚úÖ Goods Registered Successfully";
                setTimeout(() => { 
                    document.getElementById('modal').style.display = 'none';
                }, 1500);
                loadHistory();
            }).catch(err => {
                document.getElementById("result").textContent = "‚ùå Failed to register goods.";
                console.error(err);
            });
        }

        function loadHistory() {
            const historyDiv = document.getElementById("historyList");
            historyDiv.innerHTML = "<p>Loading...</p>";
            db.collection("orders").orderBy("createdAt", "desc").limit(10).get()
                .then(snapshot => {
                    historyDiv.innerHTML = "";
                    if (snapshot.empty) {
                        historyDiv.innerHTML = "<p>No history found.</p>";
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const createdAt = data.createdAt?.toDate().toLocaleString() || "N/A";
                        const item = document.createElement("div");
                        item.className = "history-item";
                        item.innerHTML = `
                            <h5>üì¶ ${data.orderId || 'N/A'} - ${data.status || 'N/A'}</h5>
                            <p><strong>AWB:</strong> ${data.awb || 'N/A'}</p>
                            <p><strong>Mobile:</strong> ${data.mobile || 'N/A'}</p>
                            <p><strong>Location:</strong> ${data.location || 'N/A'}</p>
                            <p><strong>ETA:</strong> ${data.eta || 'N/A'}</p>
                            <p><strong>Description:</strong> ${data.description || 'N/A'}</p>
                            <p><em>Created: ${createdAt}</em></p>
                        `;
                        historyDiv.appendChild(item);
                    });
                })
                .catch(error => {
                    historyDiv.innerHTML = "<p>Error loading history.</p>";
                    console.error(error);
                });
        }

        window.onload = loadHistory; 
    </script>
</body>
</html>